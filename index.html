<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story to Canva Book Layout Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Taurus, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            padding: 30px;
            text-align: center;
            color: white;
            position: relative;
        }

        .debug-button {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.4);
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .debug-button:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .upload-section {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .upload-section:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .upload-section.dragover {
            border-color: #ff6b6b;
            background: #fff5f5;
            transform: scale(1.02);
        }

        .file-input {
            display: none;
        }

        .upload-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .setting-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border-left: 4px solid #667eea;
        }

        .setting-group h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
            margin-bottom: 10px;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .process-button {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 30px auto;
        }

        .process-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(255, 107, 107, 0.3);
        }

        .process-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            margin-top: 40px;
            display: none;
        }

        .page {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
            min-height: 400px;
        }

        .page-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .page-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .page-actions {
            display: flex;
            gap: 5px;
            align-items: center;
            flex-wrap: wrap;
        }

        .page-content {
            padding: 20px;
            min-height: 350px;
            line-height: 1.6;
            position: relative;
        }

        .editable-content {
            min-height: 300px;
            padding: 15px;
            border: 2px dashed transparent;
            border-radius: 8px;
            transition: all 0.3s ease;
            outline: none;
            font-family: 'Georgia', serif;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .editable-content:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .editable-content:focus {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.05);
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }

        .character-counter {
            font-size: 0.9em;
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .character-counter.optimal {
            background: #d4edda;
            color: #155724;
        }

        .character-counter.warning {
            background: #fff3cd;
            color: #856404;
        }

        .character-counter.overflow {
            background: #f8d7da;
            color: #721c24;
        }

        .flow-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10;
        }

        .flow-indicator.active {
            opacity: 1;
        }

        .image-placeholder {
            background: linear-gradient(45deg, #f0f2ff, #fff5f5);
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 15px 0;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-placeholder:hover {
            border-color: #ff6b6b;
            background: linear-gradient(45deg, #fff5f5, #f0f2ff);
            transform: scale(1.02);
        }

        .image-placeholder.half-page {
            height: 150px;
        }

        .image-placeholder.full-page {
            height: 300px;
        }

        .image-placeholder .placeholder-text {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .image-placeholder .placeholder-details {
            font-size: 0.9em;
            color: #666;
        }

        .image-placeholder .remove-image {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toolbar {
            background: #f8f9fa;
            padding: 10px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .toolbar-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .toolbar-button:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .toolbar-button.image-btn {
            background: #28a745;
        }

        .toolbar-button.image-btn:hover {
            background: #218838;
        }

        .toolbar-button.break-btn {
            background: #ffc107;
            color: #333;
        }

        .toolbar-button.break-btn:hover {
            background: #e0a800;
        }

        .copy-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
        }

        .copy-button:hover {
            background: #218838;
            transform: scale(1.05);
        }

        .delete-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
        }

        .delete-button:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        .export-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: center;
        }

        .export-button {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .export-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .status-message {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }

            .page-header {
                flex-direction: column;
                gap: 10px;
            }

            .toolbar {
                flex-direction: column;
            }
        }

        /* Print styles will be added in Phase 3 */
        @media print {
            body { background: white; padding: 0; margin: 0; }
            .container { box-shadow: none; border-radius: 0; }
            .header, .main-content > *:not(.results-section) { display: none !important; }
            .results-section { display: block !important; margin: 0; padding: 0; }
            .page { page-break-after: always; margin: 0; border: none; }
            .page-header, .toolbar { display: none; }
            .page-content { padding: 0.5in; }
            .image-placeholder { border-color: #999; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="debug-button" onclick="showDebugConsole()">🐛 Debug Console</button>
            <h1>📚 Story to Canva Layout Generator</h1>
            <p>Transform your stories into perfectly formatted book layouts with real-time character flow</p>
        </div>

        <div class="main-content">
            <div class="upload-section" id="uploadSection">
                <h2>📄 Upload Your Story Document</h2>
                <p>Drag and drop your Word document here, or click to browse</p>
                <input type="file" id="fileInput" class="file-input" accept=".docx,.doc">
                <button class="upload-button" onclick="document.getElementById('fileInput').click()">
                    Choose Document
                </button>
                <div id="fileName" style="margin-top: 15px; font-weight: bold; color: #667eea;"></div>
            </div>

            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="status-message" id="statusMessage"></div>

            <div class="settings-grid">
                <div class="setting-group">
                    <h3>📖 Book Type</h3>
                    <select id="bookType" class="form-control">
                        <option value="text">Text-based Book</option>
                        <option value="illustrated">Text + Illustration Book</option>
                        <option value="chapter">Chapter Book</option>
                        <option value="collection">Multi-Author Collection</option>
                    </select>
                </div>

                <div class="setting-group">
                    <h3>📏 Book Size</h3>
                    <select id="bookSize" class="form-control">
                        <option value="illustration">Illustration Book (8" x 8")</option>
                        <option value="standard">Standard Book (5.5" x 8.5")</option>
                    </select>
                </div>

                <div class="setting-group">
                    <h3>🔤 Characters Per Page</h3>
                    <input type="number" id="charactersPerPage" class="form-control" value="1800" min="1000" max="3000" step="100">
                    <small style="color: #666;">Adjust based on target age group (1000-1500 for younger kids, 1800-2500 for older)</small>
                </div>

                <div class="setting-group">
                    <h3>🎨 Illustration Frequency</h3>
                    <select id="illustrationFreq" class="form-control">
                        <option value="none">No Illustrations</option>
                        <option value="every">Every Page</option>
                        <option value="alternate">Every Other Page</option>
                        <option value="chapter">Per Chapter/Section</option>
                    </select>
                </div>
            </div>

            <button class="process-button" id="processButton" onclick="processDocument()">
                🚀 Generate Book Layout
            </button>

            <div class="results-section" id="resultsSection">
                <h2>📋 Generated Book Layout</h2>
                
                <div id="pagesContainer"></div>
                
                <div class="export-section">
                    <h3>📤 Export Options</h3>
                    <button class="export-button" onclick="exportToText()">📄 Export as Text File</button>
                    <button class="export-button" onclick="copyAllPages()">📋 Copy All Pages</button>
                    <button class="export-button" onclick="generateCanvaInstructions()">🎨 Generate Canva Instructions</button>
                    <button class="export-button" onclick="generatePDF()">📄 Generate PDF</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        var documentText = '';
        var documentHTML = '';
        var documentStructure = [];
        var processedPages = [];
        var targetCharactersPerPage = 1800;
        var isReflowing = false;
        var currentBookSize = 'standard';
        var reflowTimeout = null;
        var currentCursorPage = null;

        // Initialize when page loads
        window.onload = function() {
            console.log('App loaded successfully');
            setupEventListeners();
        };

        function setupEventListeners() {
            var uploadSection = document.getElementById('uploadSection');
            var fileInput = document.getElementById('fileInput');

            uploadSection.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadSection.classList.add('dragover');
            });

            uploadSection.addEventListener('dragleave', function() {
                uploadSection.classList.remove('dragover');
            });

            uploadSection.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
                var files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });

            // Characters per page change listener
            document.getElementById('charactersPerPage').addEventListener('change', function(e) {
                targetCharactersPerPage = parseInt(e.target.value);
                if (processedPages.length > 0) {
                    scheduleReflow();
                }
            });
        }

        // Debug console functions
        function showDebugConsole() {
            var debugConsole = document.getElementById('debugConsole');
            if (!debugConsole) {
                addDebugConsole();
            }
            document.getElementById('debugConsole').style.display = 'block';
            logToDebug('Debug console opened - Character-based flow system active!', 'success');
        }

        function addDebugConsole() {
            var debugDiv = document.createElement('div');
            debugDiv.id = 'debugConsole';
            debugDiv.style.cssText = 'position: fixed; bottom: 20px; right: 20px; width: 450px; max-height: 400px; background: #1a1a1a; color: #00ff00; font-family: monospace; font-size: 12px; padding: 15px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); overflow-y: auto; z-index: 1000; display: none; border: 2px solid #333;';
            
            debugDiv.innerHTML = '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 8px;"><strong style="color: #ffffff; font-size: 14px;">🐛 Debug Console - Character Flow</strong><button onclick="document.getElementById(\'debugConsole\').style.display=\'none\'" style="background: #ff4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold;">✕ Close</button></div><div id="debugLog" style="max-height: 320px; overflow-y: auto;"></div><div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #333; font-size: 10px; color: #888;">💡 Real-time character flow and page management</div>';
            
            document.body.appendChild(debugDiv);
        }

        function logToDebug(message, type) {
            var debugLog = document.getElementById('debugLog');
            if (debugLog) {
                var colors = {
                    info: '#00ff00',
                    warn: '#ffaa00', 
                    error: '#ff4444',
                    success: '#00aa00',
                    flow: '#00aaff'
                };
                
                var timestamp = new Date().toLocaleTimeString();
                var color = colors[type] || '#00ff00';
                debugLog.innerHTML += '<div style="color: ' + color + '; margin-bottom: 3px;">[' + timestamp + '] ' + message + '</div>';
                debugLog.scrollTop = debugLog.scrollHeight;
            }
        }

        // File handling
        function handleFile(file) {
            logToDebug('Starting file upload process...', 'info');
            logToDebug('File: ' + file.name + ' (' + file.size + ' bytes)', 'info');

            if (!file.name.match(/\.(docx|doc)$/i)) {
                logToDebug('Invalid file type: ' + file.name, 'error');
                showStatus('Please select a Word document (.docx or .doc)', 'error');
                return;
            }

            var fileName = document.getElementById('fileName');
            fileName.innerHTML = 'Selected: ' + file.name;
            showProgress(true);
            updateProgress(20);
            logToDebug('File validation passed, starting FileReader...', 'success');

            var reader = new FileReader();
            
            reader.onerror = function(e) {
                logToDebug('FileReader error: ' + e, 'error');
                showStatus('Error reading file. Please try again.', 'error');
                showProgress(false);
            };

            reader.onload = function(e) {
                logToDebug('FileReader completed, file size: ' + e.target.result.byteLength + ' bytes', 'info');
                updateProgress(50);
                
                try {
                    var options = {
                        styleMap: [
                            "p[style-name='Heading 1'] => h1:fresh",
                            "p[style-name='Heading 2'] => h2:fresh",
                            "p[style-name='Heading 3'] => h3:fresh"
                        ]
                    };

                    logToDebug('Starting Mammoth processing...', 'info');
                    
                    Promise.all([
                        mammoth.convertToHtml({arrayBuffer: e.target.result}, options),
                        mammoth.extractRawText({arrayBuffer: e.target.result})
                    ]).then(function(results) {
                        logToDebug('Mammoth processing successful', 'success');
                        logToDebug('HTML result length: ' + results[0].value.length, 'info');
                        logToDebug('Text result length: ' + results[1].value.length, 'info');

                        documentHTML = results[0].value;
                        documentText = results[1].value;
                        
                        logToDebug('Parsing document structure...', 'info');
                        documentStructure = parseDocumentStructure(documentHTML);
                        logToDebug('Document structure: ' + documentStructure.length + ' elements found', 'success');
                        
                        updateProgress(100);
                        showStatus('Document loaded successfully with formatting!', 'success');
                        setTimeout(function() { showProgress(false); }, 1000);
                        
                        showFormattingPreview(documentStructure);
                    })
                    .catch(function(err) {
                        logToDebug('Mammoth processing error: ' + err.message, 'error');
                        showStatus('Error processing document: ' + err.message, 'error');
                        showProgress(false);
                    });
                    
                } catch (err) {
                    logToDebug('Unexpected error in handleFile: ' + err.message, 'error');
                    showStatus('Unexpected error: ' + err.message, 'error');
                    showProgress(false);
                }
            };
            
            logToDebug('Starting FileReader.readAsArrayBuffer...', 'info');
            reader.readAsArrayBuffer(file);
        }

        function parseDocumentStructure(html) {
            logToDebug('Parsing document structure from HTML...', 'info');
            
            try {
                var parser = new DOMParser();
                var doc = parser.parseFromString(html, 'text/html');
                var elements = doc.body.children;
                var structure = [];
                
                logToDebug('Found ' + elements.length + ' elements in document body', 'info');
                
                for (var i = 0; i < elements.length; i++) {
                    var element = elements[i];
                    var item = {
                        tag: element.tagName.toLowerCase(),
                        content: element.textContent.trim(),
                        html: element.outerHTML,
                        isHeading: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6'].indexOf(element.tagName.toLowerCase()) !== -1,
                        isEmpty: element.textContent.trim() === ''
                    };
                    
                    if (!item.isEmpty) {
                        structure.push(item);
                    }
                }
                
                logToDebug('Document structure parsed: ' + structure.length + ' non-empty elements', 'success');
                return structure;
                
            } catch (err) {
                logToDebug('Error parsing document structure: ' + err.message, 'error');
                return [{
                    tag: 'p',
                    content: html.replace(/<[^>]*>/g, ''),
                    html: html,
                    isHeading: false,
                    isEmpty: false
                }];
            }
        }

        function showFormattingPreview(structure) {
            logToDebug('Showing formatting preview...', 'info');
            
            try {
                var headings = structure.filter(function(item) { return item.isHeading; });
                logToDebug('Found headings: ' + headings.length, 'info');
                
                if (headings.length > 0) {
                    var fileName = document.getElementById('fileName');
                    var previewDiv = document.createElement('div');
                    previewDiv.style.cssText = 'background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #28a745;';
                    
                    var headingsList = headings.slice(0, 5).map(function(h) { return '• ' + h.content; }).join('<br>');
                    var moreText = headings.length > 5 ? '<br>• ... and more' : '';
                    
                    previewDiv.innerHTML = '<strong>📋 Detected Document Structure:</strong><br><small style="color: #666;">Found ' + headings.length + ' headings - Character-based flow system ready!</small><br>' + headingsList + moreText;
                    fileName.appendChild(previewDiv);
                    logToDebug('Formatting preview displayed', 'success');
                } else {
                    logToDebug('No headings found for preview', 'info');
                }
            } catch (err) {
                logToDebug('Error showing formatting preview: ' + err.message, 'error');
            }
        }

        function processDocument() {
            logToDebug('Starting document processing with character-based flow...', 'info');
            
            if (!documentHTML && !documentText) {
                showStatus('Please upload a document first', 'error');
                return;
            }

            showProgress(true);
            updateProgress(10);

            var bookType = document.getElementById('bookType').value;
            var bookSize = document.getElementById('bookSize').value;
            var charactersPerPage = parseInt(document.getElementById('charactersPerPage').value);
            var illustrationFreq = document.getElementById('illustrationFreq').value;

            targetCharactersPerPage = charactersPerPage;
            currentBookSize = bookSize;

            logToDebug('Processing with settings: ' + bookType + ', ' + bookSize + ', ' + charactersPerPage + ' chars/page', 'info');

            updateProgress(30);
            processedPages = createCharacterBasedLayout(documentStructure, bookType, charactersPerPage, illustrationFreq);
            
            updateProgress(70);
            renderFormattedPages(processedPages);
            
            updateProgress(100);
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
            
            showStatus('Successfully generated ' + processedPages.length + ' pages with character-based flow!', 'success');
            setTimeout(function() { showProgress(false); }, 1000);
        }

        function createCharacterBasedLayout(structure, bookType, charactersPerPage, illustrationFreq) {
            var pages = [];
            var currentPageContent = '';
            var currentPageImages = [];
            var pageNumber = 1;

            logToDebug('Creating character-based layout with ' + charactersPerPage + ' characters per page target', 'info');

            // Combine all content into a single text string
            var allContent = structure.map(function(item) {
                return item.content;
            }).join('\n\n');

            logToDebug('Total content: ' + allContent.length + ' characters', 'info');

            // Split content into pages based on character count
            var words = allContent.split(/\s+/);
            var currentText = '';
            var currentCharCount = 0;

            for (var i = 0; i < words.length; i++) {
                var word = words[i];
                var testText = currentText + (currentText ? ' ' : '') + word;
                
                if (testText.length > charactersPerPage && currentText.length > 0) {
                    // Create page with current content
                    var needsIllustration = shouldHaveIllustration(illustrationFreq, pageNumber);
                    var availableChars = charactersPerPage - (needsIllustration ? 200 : 0); // Reserve space for image
                    
                    pages.push(createCharacterPage(pageNumber, currentText.trim(), needsIllustration));
                    logToDebug('Created page ' + pageNumber + ' with ' + currentText.length + ' characters', 'success');
                    
                    currentText = word;
                    pageNumber++;
                } else {
                    currentText = testText;
                }
            }

            // Add final page if there's remaining content
            if (currentText.trim().length > 0) {
                var needsIllustration = shouldHaveIllustration(illustrationFreq, pageNumber);
                pages.push(createCharacterPage(pageNumber, currentText.trim(), needsIllustration));
                logToDebug('Created final page ' + pageNumber + ' with ' + currentText.length + ' characters', 'success');
            }

            logToDebug('Character-based layout complete: ' + pages.length + ' pages created', 'success');
            return pages;
        }

        function createCharacterPage(pageNum, content, hasIllustration) {
            var characterCount = content.length;
            var images = [];
            
            if (hasIllustration) {
                images.push({
                    type: 'half',
                    id: 'img_' + pageNum + '_1'
                });
            }
            
            return {
                number: pageNum,
                content: content,
                characterCount: characterCount,
                images: images,
                hasIllustration: hasIllustration
            };
        }

        function shouldHaveIllustration(freq, pageNum) {
            switch (freq) {
                case 'every': return true;
                case 'alternate': return pageNum % 2 === 0;
                case 'chapter': return pageNum === 1;
                case 'none':
                default: return false;
            }
        }

        function renderFormattedPages(pages) {
            var container = document.getElementById('pagesContainer');
            container.innerHTML = '';

            for (var i = 0; i < pages.length; i++) {
                var page = pages[i];
                var pageDiv = document.createElement('div');
                pageDiv.className = 'page size-' + currentBookSize;
                pageDiv.setAttribute('data-page-index', i);

                // Flow indicator
                var flowIndicator = document.createElement('div');
                flowIndicator.className = 'flow-indicator';
                flowIndicator.textContent = 'Flowing...';

                // Page header
                var headerDiv = document.createElement('div');
                headerDiv.className = 'page-header';
                
                var pageInfo = document.createElement('div');
                pageInfo.className = 'page-info';
                
                var characterCountClass = getCharacterCountClass(page.characterCount);
                var characterCountHtml = '<span class="character-counter ' + characterCountClass + '">' + page.characterCount + ' / ' + targetCharactersPerPage + ' chars</span>';
                
                pageInfo.innerHTML = '<span>Page ' + page.number + '</span>' + characterCountHtml;
                
                // Page actions
                var pageActions = document.createElement('div');
                pageActions.className = 'page-actions';
                pageActions.innerHTML = 
                    '<button class="copy-button" onclick="copyFormattedPage(' + i + ', \'text\')">Copy Text</button>' +
                    '<button class="copy-button" onclick="copyFormattedPage(' + i + ', \'formatted\')">Copy HTML</button>' +
                    (processedPages.length > 1 ? '<button class="delete-button" onclick="deletePage(' + i + ')">Delete</button>' : '');
                
                headerDiv.appendChild(pageInfo);
                headerDiv.appendChild(pageActions);

                // Toolbar
                var toolbar = document.createElement('div');
                toolbar.className = 'toolbar';
                toolbar.innerHTML = 
                    '<button class="toolbar-button image-btn" onclick="insertImagePlaceholder(' + i + ', \'half\')">📷 Half Image</button>' +
                    '<button class="toolbar-button image-btn" onclick="insertImagePlaceholder(' + i + ', \'full\')">🖼️ Full Image</button>' +
                    '<button class="toolbar-button break-btn" onclick="forcePageBreak(' + i + ')">⏎ Force Break</button>';

                // Page content
                var contentDiv = document.createElement('div');
                contentDiv.className = 'page-content';

                // Render existing images
                for (var j = 0; j < page.images.length; j++) {
                    var img = page.images[j];
                    var imgPlaceholder = createImageElement(img.type, img.id, i);
                    contentDiv.appendChild(imgPlaceholder);
                }

                // Editable text content
                var editableDiv = document.createElement('div');
                editableDiv.className = 'editable-content';
                editableDiv.contentEditable = true;
                editableDiv.setAttribute('data-page-index', i);
                editableDiv.textContent = page.content;
                
                // Add input event listener for real-time character flow
                editableDiv.addEventListener('input', function(e) {
                    handleTextInput(e);
                });

                // Add cursor tracking
                editableDiv.addEventListener('focus', function(e) {
                    currentCursorPage = parseInt(e.target.getAttribute('data-page-index'));
                });

                contentDiv.appendChild(editableDiv);
                
                pageDiv.appendChild(flowIndicator);
                pageDiv.appendChild(headerDiv);
                pageDiv.appendChild(toolbar);
                pageDiv.appendChild(contentDiv);
                container.appendChild(pageDiv);
            }
        }

        function createImageElement(type, id, pageIndex) {
            var imgDiv = document.createElement('div');
            imgDiv.className = 'image-placeholder ' + type + '-page';
            imgDiv.setAttribute('data-image-id', id);
            imgDiv.setAttribute('data-page-index', pageIndex);
            
            var placeholderText = document.createElement('div');
            placeholderText.className = 'placeholder-text';
            placeholderText.textContent = type === 'half' ? '🖼️ HALF PAGE IMAGE' : '🖼️ FULL PAGE IMAGE';
            
            var placeholderDetails = document.createElement('div');
            placeholderDetails.className = 'placeholder-details';
            placeholderDetails.textContent = type === 'half' ? 
                'This image will occupy half the page height' : 
                'This image will occupy most of the page';
            
            var removeBtn = document.createElement('button');
            removeBtn.className = 'remove-image';
            removeBtn.innerHTML = '×';
            removeBtn.onclick = function() {
                removeImagePlaceholder(id, pageIndex);
            };
            
            imgDiv.appendChild(removeBtn);
            imgDiv.appendChild(placeholderText);
            imgDiv.appendChild(placeholderDetails);
            
            return imgDiv;
        }

        function getCharacterCountClass(charCount) {
            var min = targetCharactersPerPage - 200;  // 1600 for target 1800
            var max = targetCharactersPerPage + 200;  // 2000 for target 1800
            var overflow = targetCharactersPerPage + 400; // 2200 for target 1800
            
            if (charCount >= min && charCount <= max) {
                return 'optimal';
            } else if (charCount <= overflow) {
                return 'warning';
            } else {
                return 'overflow';
            }
        }

        function handleTextInput(event) {
            if (isReflowing) return;
            
            var editableDiv = event.target;
            var pageIndex = parseInt(editableDiv.getAttribute('data-page-index'));
            
            // Update the page content in our data structure
            var newContent = editableDiv.textContent || editableDiv.innerText;
            processedPages[pageIndex].content = newContent;
            processedPages[pageIndex].characterCount = newContent.length;
            
            logToDebug('Page ' + (pageIndex + 1) + ' edited: ' + newContent.length + ' characters', 'flow');
            
            // Update character counter display
            updateCharacterCounter(pageIndex);
            
            // Schedule reflow after a short delay to avoid excessive calls
            scheduleReflow();
        }

        function scheduleReflow() {
            if (reflowTimeout) {
                clearTimeout(reflowTimeout);
            }
            reflowTimeout = setTimeout(function() {
                performReflow();
            }, 500); // 500ms delay
        }

        function performReflow() {
            if (isReflowing) return;
            isReflowing = true;
            
            logToDebug('Starting character-based reflow...', 'flow');
            
            // Show flow indicators
            var flowIndicators = document.querySelectorAll('.flow-indicator');
            flowIndicators.forEach(function(indicator) {
                indicator.classList.add('active');
            });

            // Collect all text content
            var allContent = '';
            for (var i = 0; i < processedPages.length; i++) {
                if (i > 0) allContent += ' ';
                allContent += processedPages[i].content;
            }

            logToDebug('Total content for reflow: ' + allContent.length + ' characters', 'flow');

            // Redistribute content across pages
            var words = allContent.split(/\s+/).filter(function(word) { return word.length > 0; });
            var newPages = [];
            var currentText = '';
            var pageNumber = 1;

            for (var i = 0; i < words.length; i++) {
                var word = words[i];
                var testText = currentText + (currentText ? ' ' : '') + word;
                var availableChars = getAvailableCharacters(pageNumber);
                
                if (testText.length > availableChars && currentText.length > 0) {
                    // Create page with current content
                    var hasIllustration = shouldHaveIllustration(
                        document.getElementById('illustrationFreq').value, 
                        pageNumber
                    );
                    newPages.push(createCharacterPage(pageNumber, currentText.trim(), hasIllustration));
                    
                    currentText = word;
                    pageNumber++;
                } else {
                    currentText = testText;
                }
            }

            // Add final page if there's remaining content
            if (currentText.trim().length > 0) {
                var hasIllustration = shouldHaveIllustration(
                    document.getElementById('illustrationFreq').value, 
                    pageNumber
                );
                newPages.push(createCharacterPage(pageNumber, currentText.trim(), hasIllustration));
            }

            // Update processed pages
            processedPages = newPages;
            
            logToDebug('Reflow complete: ' + newPages.length + ' pages', 'flow');
            
            // Re-render pages
            renderFormattedPages(processedPages);
            
            // Hide flow indicators
            setTimeout(function() {
                var flowIndicators = document.querySelectorAll('.flow-indicator');
                flowIndicators.forEach(function(indicator) {
                    indicator.classList.remove('active');
                });
                isReflowing = false;
            }, 1000);
        }

        function getAvailableCharacters(pageNumber) {
            var baseChars = targetCharactersPerPage;
            var illustrationFreq = document.getElementById('illustrationFreq').value;
            var hasIllustration = shouldHaveIllustration(illustrationFreq, pageNumber);
            
            // Reduce available characters based on image placeholders
            if (hasIllustration) {
                baseChars -= 200; // Reserve space for half-page image
            }
            
            return baseChars;
        }

        function updateCharacterCounter(pageIndex) {
            var page = processedPages[pageIndex];
            var headerDiv = document.querySelector('[data-page-index="' + pageIndex + '"] .page-header .page-info');
            var characterCountClass = getCharacterCountClass(page.characterCount);
            var characterCountHtml = '<span class="character-counter ' + characterCountClass + '">' + page.characterCount + ' / ' + targetCharactersPerPage + ' chars</span>';
            
            headerDiv.innerHTML = '<span>Page ' + page.number + '</span>' + characterCountHtml;
        }

        // Image placeholder functions
        function insertImagePlaceholder(pageIndex, type) {
            logToDebug('Inserting ' + type + ' image placeholder on page ' + (pageIndex + 1), 'info');
            
            var page = processedPages[pageIndex];
            var newImageId = 'img_' + page.number + '_' + (page.images.length + 1);
            
            page.images.push({
                type: type,
                id: newImageId
            });
            
            // Re-render the page
            var pageDiv = document.querySelector('[data-page-index="' + pageIndex + '"]');
            var contentDiv = pageDiv.querySelector('.page-content');
            
            // Add the new image placeholder
            var editableDiv = contentDiv.querySelector('.editable-content');
            var imgElement = createImageElement(type, newImageId, pageIndex);
            contentDiv.insertBefore(imgElement, editableDiv);
            
            // Update available character space
            var reservedChars = type === 'half' ? 200 : 400;
            if (page.content.length > targetCharactersPerPage - reservedChars) {
                scheduleReflow();
            }
            
            showStatus('Image placeholder added successfully!', 'success');
        }

        function removeImagePlaceholder(imageId, pageIndex) {
            logToDebug('Removing image placeholder ' + imageId + ' from page ' + (pageIndex + 1), 'info');
            
            var page = processedPages[pageIndex];
            page.images = page.images.filter(function(img) {
                return img.id !== imageId;
            });
            
            // Remove from DOM
            var imgElement = document.querySelector('[data-image-id="' + imageId + '"]');
            if (imgElement) {
                imgElement.remove();
            }
            
            // Trigger reflow since we have more space now
            scheduleReflow();
            
            showStatus('Image placeholder removed!', 'success');
        }

        function forcePageBreak(pageIndex) {
            logToDebug('Forcing page break at page ' + (pageIndex + 1), 'info');
            
            // Get cursor position in the editable div
            var editableDiv = document.querySelector('[data-page-index="' + pageIndex + '"] .editable-content');
            var selection = window.getSelection();
            
            if (selection.rangeCount > 0) {
                var range = selection.getRangeAt(0);
                var cursorPos = range.startOffset;
                var textContent = editableDiv.textContent;
                
                // Split content at cursor position
                var beforeCursor = textContent.substring(0, cursorPos);
                var afterCursor = textContent.substring(cursorPos);
                
                // Update current page with content before cursor
                processedPages[pageIndex].content = beforeCursor;
                processedPages[pageIndex].characterCount = beforeCursor.length;
                
                // Create new page with content after cursor
                var newPageNumber = processedPages.length + 1;
                var newPage = createCharacterPage(newPageNumber, afterCursor, false);
                
                // Insert new page after current page
                processedPages.splice(pageIndex + 1, 0, newPage);
                
                // Renumber pages
                for (var i = 0; i < processedPages.length; i++) {
                    processedPages[i].number = i + 1;
                }
                
                // Re-render
                renderFormattedPages(processedPages);
                
                showStatus('Page break inserted successfully!', 'success');
            } else {
                showStatus('Place cursor where you want to break the page', 'error');
            }
        }

        // Copy and export functions
        function copyFormattedPage(index, format) {
            var page = processedPages[index];
            var textToCopy = '';
            
            if (format === 'formatted') {
                textToCopy = convertToCanvaFormat(page);
            } else {
                textToCopy = page.content;
                
                // Add image placeholders to text
                for (var i = 0; i < page.images.length; i++) {
                    var img = page.images[i];
                    textToCopy = '[' + img.type.toUpperCase() + ' IMAGE PLACEHOLDER]\n\n' + textToCopy;
                }
            }

            navigator.clipboard.writeText(textToCopy).then(function() {
                showStatus('Page copied to clipboard (' + format + ' format)!', 'success');
            });
        }

        function convertToCanvaFormat(page) {
            var canvaText = '';
            
            // Add image placeholders
            for (var i = 0; i < page.images.length; i++) {
                var img = page.images[i];
                canvaText += '[ADD ' + img.type.toUpperCase() + ' IMAGE HERE]\n\n';
            }
            
            canvaText += page.content;
            
            return canvaText;
        }

        function copyAllPages() {
            var allText = '';
            for (var i = 0; i < processedPages.length; i++) {
                allText += convertToCanvaFormat(processedPages[i]) + '\n---\n\n';
            }
            navigator.clipboard.writeText(allText).then(function() {
                showStatus('All pages copied to clipboard (Canva format)!', 'success');
            });
        }

        function exportToText() {
            var content = 'Book Layout Export (Character-Based Flow)\nGenerated: ' + new Date().toLocaleDateString() + '\nTotal Pages: ' + processedPages.length + '\nCharacters per page: ' + targetCharactersPerPage + '\n\n';
            content += '==================================================\n\n';

            for (var i = 0; i < processedPages.length; i++) {
                var page = processedPages[i];
                content += 'PAGE ' + page.number + ' (' + page.characterCount + ' characters)\n';
                content += '==================================================\n';
                
                // Add image placeholders
                for (var j = 0; j < page.images.length; j++) {
                    var img = page.images[j];
                    content += '[' + img.type.toUpperCase() + ' IMAGE PLACEHOLDER - ' + img.id + ']\n\n';
                }
                
                content += page.content + '\n\n';
                
                if (i < processedPages.length - 1) {
                    content += '==================================================\n\n';
                }
            }

            var blob = new Blob([content], { type: 'text/plain' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'book-layout-character-based.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        function generateCanvaInstructions() {
            var instructions = 'Canva Book Layout Instructions (Character-Based Flow)\n';
            instructions += '==================================================\n\n';
            instructions += 'Book Details:\n';
            instructions += '- Total Pages: ' + processedPages.length + '\n';
            instructions += '- Book Type: ' + document.getElementById('bookType').value + '\n';
            instructions += '- Book Size: ' + document.getElementById('bookSize').value + '\n';
            instructions += '- Characters per Page: ' + document.getElementById('charactersPerPage').value + '\n';
            instructions += '- Layout System: Character-based flow with real-time editing\n\n';
            
            instructions += 'Image Placement Guide:\n';
            instructions += '- Half-page images reserve ~200 characters of space\n';
            instructions += '- Full-page images reserve ~400 characters of space\n';
            instructions += '- Images can be placed anywhere in the page flow\n\n';
            
            instructions += 'Steps for Canva:\n';
            instructions += '1. Create a new design with your chosen book dimensions\n';
            instructions += '2. For each page below, create a new page in Canva\n';
            instructions += '3. Add image placeholders first (they determine text space)\n';
            instructions += '4. Copy the text content into text boxes\n';
            instructions += '5. Ensure consistent spacing and alignment\n';
            instructions += '6. Replace image placeholders with actual artwork\n\n';
            
            instructions += 'Page-by-Page Content:\n';
            instructions += '==================================================\n\n';

            for (var i = 0; i < processedPages.length; i++) {
                var page = processedPages[i];
                instructions += 'PAGE ' + page.number + ' (' + page.characterCount + ' characters):\n\n';
                
                // Add image instructions
                if (page.images.length > 0) {
                    instructions += 'IMAGES TO ADD:\n';
                    for (var j = 0; j < page.images.length; j++) {
                        var img = page.images[j];
                        instructions += '- ' + img.type.toUpperCase() + ' page image (' + img.id + ')\n';
                    }
                    instructions += '\n';
                }
                
                instructions += 'TEXT CONTENT:\n';
                instructions += page.content + '\n\n';
                
                var separator = '';
                for (var k = 0; k < 50; k++) {
                    separator += '-';
                }
                instructions += separator + '\n\n';
            }

            var blob = new Blob([instructions], { type: 'text/plain' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'canva-instructions-character-flow.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        function generatePDF() {
            showStatus('PDF generation will be improved in Phase 3. Currently using browser print...', 'success');
            
            // For now, use browser print - this will be enhanced in Phase 3
            setTimeout(function() {
                window.print();
            }, 1000);
        }

        function deletePage(pageIndex) {
            if (processedPages.length <= 1) {
                showStatus('Cannot delete the only page!', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to delete this page? The content will be merged with adjacent pages.')) {
                logToDebug('Deleting page ' + (pageIndex + 1), 'info');
                
                // Merge content with next page if it exists, otherwise with previous page
                var deletedContent = processedPages[pageIndex].content;
                
                if (pageIndex < processedPages.length - 1) {
                    // Merge with next page
                    processedPages[pageIndex + 1].content = deletedContent + ' ' + processedPages[pageIndex + 1].content;
                    processedPages[pageIndex + 1].characterCount = processedPages[pageIndex + 1].content.length;
                } else if (pageIndex > 0) {
                    // Merge with previous page
                    processedPages[pageIndex - 1].content = processedPages[pageIndex - 1].content + ' ' + deletedContent;
                    processedPages[pageIndex - 1].characterCount = processedPages[pageIndex - 1].content.length;
                }
                
                // Remove the page
                processedPages.splice(pageIndex, 1);
                
                // Renumber pages
                for (var i = 0; i < processedPages.length; i++) {
                    processedPages[i].number = i + 1;
                }
                
                // Trigger reflow to redistribute content properly
                scheduleReflow();
                
                showStatus('Page deleted and content merged successfully!', 'success');
            }
        }

        // Utility functions
        function showProgress(show) {
            document.getElementById('progressBar').style.display = show ? 'block' : 'none';
            if (!show) {
                updateProgress(0);
            }
        }

        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
        }

        function showStatus(message, type) {
            var statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = 'status-message status-' + type;
            statusDiv.style.display = 'block';
            
            setTimeout(function() {
                statusDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
